!!! 5
%html
  %head
    %title Try JUMLY
    %link{rel:"stylesheet",href:"#{$css_dir}/TryJUMLY.css"}
    %link{rel:"stylesheet",href:"#{$css_dir}/disqus.css"}
    = haml :"_head.html"
    = haml :"_bootstrap.html"
  %body
    .topbar
      .topbar-inner
        .container-fluid
          %h3 <a href="/#">JUMLY</a>
          - def _sr(n, t) "<a id='sample-#{n}' data-bind='click:sampleRequired'>#{t}</a>" end
          %ul.nav
            %li #{_sr 1, "Example-1"}
            %li #{_sr 2, "Example-2"}
            %li #{_sr 3, "Example-3"}
            %li.dropdown{"data-dropdown"=>"dropdown"}
              %a.dropdown-toggle Other examples
              %ul.dropdown-menu
                %li #{_sr 4, "Shorten w/ bit.ly"}
                %li #{_sr 5, "Using &lt;img&gt;"}
            %li <a href="/Reference.html">Reference</a>
            %li <a href="#" data-bind="click:askTutorial">Tutorial</a>
            %li <a href="#" data-controls-modal="tryjumly-help" data-backdrop="static" data-keyboard="true">Help</a>
    .container-fluid
      .page-header
        %h1 Try JUMLY <small>Sandbox for sequence Diagram</small>
        #buttons
          <div class="fb-like" data-send="true" data-layout="button_count" data-width="0" data-show-faces="false"></div>
          <a href="#" onclick="Evernote.doClip({contentId:'diagram-container',providerName:'Try JUMLY'}); return false;"><img src="http://static.evernote.com/article-clipper.png" alt="Clip to Evernote" style="margin-right:10px;"/></a>
          <div class="g-plusone" data-size="medium" data-href="http://jumly.dev/TryJUMLY"></div>
          <a href="https://twitter.com/share" class="twitter-share-button" data-via="jumly1" data-related="jumly1" data-hashtags="jumly">Tweet</a>
        %a#link-to-share.btn.primary{"data-controls-modal"=>"url-to-show","data-bind"=>"click:tutorial.share"} Link To Share
      .row
        .span7.columns
          %textarea#jumlipt{"data-bind"=>"value:targetJumlipt,valueUpdate:'afterkeydown'",rows:26,placeholder:"Write JUMLIPT here, or click one of examples."}
        .span9.columns            
          #diagram-container{"data-bind"=>"jumly:diagram,success:success,error:error"}
          = haml :"_TryJUMLYTutorial"
          
      / DISQUS thread
      <div id="disqus_thread"><div id="dsq-content-stub" style="display: none; "><img width="71" height="17" alt="DISQUS" src="data:image/png;base64,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"><img width="16" height="11" alt="..." src="data:image/gif;base64,R0lGODlhEAALAPQAAP///z2LqeLt8dvp7u7090GNqz2LqV+fuJ/F1IW2ycrf51aatHWswaXJ14i4ys3h6FmctUCMqniuw+vz9eHs8fb5+meku+Tu8vT4+cfd5bbT3tbm7PH2+AAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCwAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7AAAAAAAAAAAA" style="margin:0 0 3px 5px"></div><div id="dsq-content" style="display: block; " class="clearfix">      <div id="dsq-global-toolbar" class="dsq-clearfix">        <ul class="dsq-global-toolbar-right dsq-clearfix">                    <li class="dsq-messages">                <div id="dsq-messagesx-toolbar-icon" class=" dsq-dropdown-tab dsq-toolbar-item dsq-clearfix" onclick="DISQUS.dtpl.actions.fire('messagesx.toggleBar'); return false;">                    <a href="#" class="dsq-message-count dsq-toolbar-label" id="dsq-messagesx-count">0</a>                </div>                <div id="dsq-messagesx-toolbar-dropdown" class="dsq-dropdown">                    <h4>Notifications</h4>                    <ul class="dsq-inbox" id="dsq-messagesx-inbox">                      <li id="dsq-inbox-no-messages">You have no messages</li>                    </ul>                </div>                <div id="dsq-alert" class="dsq-alert dsq-alert-hidden">                  <div class="dsq-alert-notch"></div>                  <p>You've received a new rank!</p>                </div>            </li>                            <li class="dsq-community-box">                <a href="#" class="dsq-toolbar-item dsq-tt" onclick="DISQUS.dtpl.actions.fire('community.show'); return false" title="Expand Community Box"><span class="dsq-toolbar-icon"></span></a>            </li>                            <li class="dsq-admin-settings">                <a href="#" class="dsq-toolbar-item dsq-tt" onclick="DISQUS.dtpl.actions.fire('thread.settings'); return false;" title="Settings"><span class="dsq-toolbar-icon"></span></a>            </li>                    <li class="dsq-global-toolbar-dropdown-container">                    <div id="dsq-toolbar-dropdown">    <a href="#" class="dsq-toolbar-logo dsq-toolbar-item dsq-clearfix"><span class="dsq-toolbar-icon">Disqus</span></a>    <div id="dsq-toolbar-dropdown-wrap" style="display: none">      <ul class="dsq-clearfix">                                    <li class="dsq-dashboard-link"><a href="#" onclick="DISQUS.dtpl.actions.fire('profile.dashboard'); return false"><span class="dsq-toolbar-icon"></span><span class="dsq-toolbar-label">Dashboard</span></a></li>                <li class="dsq-editprofile-link"><a href="#" onclick="DISQUS.dtpl.actions.fire('profile.edit'); return false"><span class="dsq-toolbar-icon"></span><span class="dsq-toolbar-label">Edit Profile</span></a></li>                                      <li class="dsq-logout-link"><a href="http://disqus.com/logout/?ctkn=1205b38b56dceff7043dedf129a1b6ed"><span class="dsq-toolbar-icon"></span><span class="dsq-toolbar-label">Logout</span></a></li>                                <li class="dsq-about-link"><a href="http://disqus.com" target="_blank"><span class="dsq-toolbar-icon"></span><span class="dsq-toolbar-label">About Disqus</span></a></li>      </ul>    </div>  </div>            </li>        </ul>                <ul class="dsq-global-toolbar-left dsq-clearfix">            <li class="dsq-like-thread">                <a href="#" id="dsq-like-thread-button" class="dsq-toolbar-item dsq-clearfix  dsq-tt" onclick="DISQUS.dtpl.actions.fire('thread.vote', 1); return false;" title="I like this page">                    <span class="dsq-toolbar-icon"></span>                    <span class="dsq-toolbar-label">Like</span>                </a>            </li>            <li class="dsq-dislike-thread">                <a href="#" id="dsq-dislike-thread-button" class="dsq-toolbar-item dsq-clearfix  dsq-tt" onclick="DISQUS.dtpl.actions.fire('thread.vote', -1); return false" title="I don't like this page">                    <span class="dsq-toolbar-icon">Dislike</span>                </a>            </li>            <li class="dsq-like-panel">                <ul class="dsq-like-faces dsq-clearfix">                        <li class="dsq-like-activity">    </li>                </ul>            </li>        </ul>            </div>    <div id="dsq-like-tooltip">      <div id="dsq-share-step-1" class="dsq-share-step">        <h3>Glad you liked it. Would you like to share?</h3>        <p class="dsq-tooltip-checkbox"><input type="checkbox" id="dsq-share-thread-facebook" value="Facebook"><label for="dsq-share-thread-facebook"><span class="dsq-facebook">Facebook</span></label></p>        <p class="dsq-tooltip-checkbox"><input type="checkbox" id="dsq-share-thread-twitter" value="Twitter"><label for="dsq-share-thread-twitter"><span class="dsq-twitter">Twitter</span></label></p>        <ul id="dsq-tooltip-actions">                        <li><a href="#" onclick="DISQUS.dtpl.actions.fire('thread.share.send'); return false" class="dsq-primary-action">Share</a></li>                    <li><a href="#" onclick="DISQUS.dtpl.actions.fire('thread.share.cancel'); return false" class="dsq-secondary-action">No thanks</a></li>        </ul>      </div>      <div id="dsq-share-step-2" class="dsq-share-step" style="display:none !important">        <p>Sharing this page â€¦</p>      </div>      <div id="dsq-share-step-3" class="dsq-share-step" style="display:none !important">        <p>Thanks! <a href="#" class="dsq-tooltip-decline" onclick="DISQUS.dtpl.actions.fire('thread.share.cancel'); return false">Close</a></p>      </div>    </div>                                <div class="dsq-reply " id="dsq-reply">          <div id="dsq-account-dropdown">                              <a href="http://disqus.com/logout/?ctkn=1205b38b56dceff7043dedf129a1b6ed">Logout</a>                        </div>      <h3>Add New Comment</h3>        <div class="dsq-avatar">              <a href="#" onclick="return DISQUS.dtpl.actions.fire('profile.show', null, 'tomotakasakuma'); return false">          <img src="http://mediacdn.disqus.com/uploads/users/2142/1480/avatar92.jpg?1327111915" alt="tomotakasakuma">        </a>          </div>    <div class="dsq-textarea dsq-textarea-reply">      <div class="dsq-textarea-background">        <div class="dsq-textarea-wrapper" style="height: auto; ">          <!-- filled dynamically -->        <iframe name="easyXDM_DISQUS_net_default9074_provider" id="easyXDM_DISQUS_net_default9074_provider" scrolling="no" frameborder="0" src="http://mediacdn.disqus.com/1326940420/build/system/reply.html#xdm_e=http%3A%2F%2Fjumly.heroku.com&amp;xdm_c=default9074&amp;xdm_p=1&amp;f=jumly&amp;t=try_jumly&amp;ff=Helvetica%20Neue%2C%20Helvetica%2C%20Arial%2C%20sans-serif&amp;d=ltr&amp;p=Type%20your%20comment%20here.&amp;upload_media=true&amp;mentions=true" style="height: 58px; "></iframe></div>                  <div id="dsq-media-preview" class="dsq-media-preview" style="display:none">          </div>                <div class="dsq-post-tools">          <ul>            <li class="dsq-post-as">                              <button type="button" class="dsq-button" onclick="DISQUS.dtpl.actions.fire('comments.send', null, this);">                  Post as tomotakasakuma                </button>                          </li>                          <li class="dsq-attach-media">                <div class="dsq-attach-media-container dsq-attach-media-border">                  <span>Image</span>                  <!-- filled dynamically -->                <iframe name="easyXDM_DISQUS_net_default9075_provider" id="easyXDM_DISQUS_net_default9075_provider" scrolling="no" frameborder="0" src="http://mediacdn.disqus.com/1326940420/build/system/upload.html#xdm_e=http%3A%2F%2Fjumly.heroku.com&amp;xdm_c=default9075&amp;xdm_p=1&amp;f=jumly&amp;t=try_jumly"></iframe></div>              </li>                        <li class="dsq-share-on dsq-clearfix">                            </li>          </ul>        </div>      </div>    </div>  </div>                              <div id="dsq-sort-by">    <select id="dsq-sort-select" onchange="DISQUS.dtpl.actions.fire('thread.sort', this.value);">              <option value="hot" selected="selected">          Sort by popular now        </option>              <option value="best">          Sort by best rating        </option>              <option value="newest">          Sort by newest first        </option>              <option value="oldest">          Sort by oldest first        </option>          </select>  </div>      <h3>            Showing <span id="dsq-num-posts">0</span> comments        </h3>        <ul id="dsq-comments">      </ul>        <div id="dsq-pagination">      <ul id="dsq-footer" class="dsq-clearfix">        <div id="dsq-subscribe">            <li>      <a href="#" class="dsq-subscribe-email" onclick="return DISQUS.dtpl.actions.fire('thread.subscribe');">        <span class="dsq-font">M</span> <em>Subscribe by email</em>      </a>    </li>    <li>    <a href="http://jumly.disqus.com/try_jumly/latest.rss" class="dsq-subscribe-rss">      <span class="dsq-font">S</span> <em>RSS</em>    </a>  </li>    </div>  </ul>    </div>          </div><div>  </div></div>

    .bottombar
      = $copyright_html
      JUMLY v#{File.read "VERSION"}
    
    .alert-message.block-message.error.notice.hide{"data-bind"=>'template:{name:"alert-error",data:errorReason}'}
    %script#alert-error{type:"text/html"}
      %h3 Error
      %p
        %strong type: ${type}
        ${message}
      %p
        %strong message:
        %span.message ${cause}

    .alert-message.block-message.success.notice.hide
      %h3 Success
      %p Rendering was succeeded.

    #auto-save-message.alert-message.info.hide{style:"position:absolute;right:2px"}
      %p Auto-save.

    #url-to-show.modal.hide{"data-bind"=>"template:{name:'show-URL',data:urlToShare}"}
    %script#show-URL{type:"text/html"}
      .modal-header
        %h2 URL To Share
      .modal-body
        %h3 Short URL
        .short <a href='${short}' target='shortURL'>${short}</a>
        %h3 Raw URL
        .long <a href='${long}' target='rawURL'>${long}</a>
      .modal-footer
        %a.btn.cancel Close

    #tryjumly-help.modal.hide
      .modal-body
        %img{src:"/assets/TryJUMLY-overview.png",width:"100%"}
      .modal-body
        If you click one of [Examples], you get a sample <a href="/Reference.html#terminology-jumlipt">jumlipt</a> in [Input Jumplit] area.
        At the same time, a diagram corresponding to the jumplipt is rendered in [Diagram appears] area.
        If you click [Display URL to share], you get raw and shorten URL to view the diagram.
      .modal-footer
        %a.btn.cancel Close
        
    / Facebook Like button
    <div id="fb-root"></div>
    
  %script{src:"#{$js_dir}/btn.js"}
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  <script src='http://www.go2web20.net/twitterfollowbadge/1.0/badge.js' type='text/javascript'></script><script type='text/javascript' charset='utf-8'>tfb.account='jumly1';tfb.label='follow-me';tfb.color='#404040';tfb.side ='r';tfb.top=136;tfb.showbadge();</script>
  %script{src:"#{$js_dir}/base64.js"}
  %script{src:"#{$js_dir}/TryJUMLY.js"}
  %script{src:"http://static.evernote.com/noteit.js"}

  :coffeescript
    $(document).on "show", ".alert-message", (e)-> setTimeout (-> $(e.target).fadeOut()), 2000
    $(document).on "click", ".alert-message .btn.cancel", (e)-> $(this).parents(".alert-message").hide()
    $(document).on "click", ".modal .btn.cancel", (e)-> $(this).parents(".modal").modal 'hide'
    
    storage = window.localStorage
    storeKey = "TryJUMLY.sequence.jumlipt"
    qp = {}
    qp[e[0]] = e[1] for e in (e.split("=") for e in location.search.replace(/^\?/, "").split("&"))
    initialJumlipt = (if qp.b then Base64.decode qp.b else storage.getItem storeKey) || ""
    
    viewModel =
      targetJumlipt: ko.observable initialJumlipt
      sampleRequired: (model, event)->
        model.targetJumlipt JUMLY.TryJUMLY.samples[event.target.id]
      success: ->
        a = $(".alert-message").hide()
        if $(".diagram > *").length > 0
          a.filter(".success").show().trigger "show"
      errorReason: ko.observable {}
      error: (reason)->
        viewModel.errorReason reason
        $(".alert-message").hide().filter(".error").show()
      urlToShare:
        short: ko.observable "..."
        long: ko.observable "..."
      typing:
        delay:5000, stop:(e)->
          storage.setItem storeKey, viewModel.targetJumlipt()
          $("#auto-save-message").fadeIn().trigger "show"

    viewModel.diagram = JUMLY.ko.dependentObservable viewModel.targetJumlipt, 'sequence'
    
    JUMLY.TryJUMLY.Tutorial.bootup viewModel
    
    $ ->
      ko.applyBindings viewModel, $("body")[0]
      
      $("textarea").typing viewModel.typing
      $("#url-to-show").modal(backdrop:"static",keyboard:true).bind "show", ->
        path = "/Share?b=\#{Base64.encode viewModel.targetJumlipt()}"
        longUrl = "\#{location.origin}\#{path}"
        viewModel.urlToShare.long longUrl
        JUMLY.TryJUMLY.bitly longUrl, (res)->
          console.error "bit.ly returns something wrong.", res if res.errorCode
          viewModel.urlToShare.short res.results[longUrl].shortUrl

      JUMLY.TryJUMLY.Tutorial.start viewModel
